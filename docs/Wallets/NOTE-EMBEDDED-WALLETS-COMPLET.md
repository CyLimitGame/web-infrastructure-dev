# üìö Note Compl√®te : Embedded Wallets Coinbase CDP

**Date :** 7 octobre 2025  
**Source :** [docs.cdp.coinbase.com/embedded-wallets](https://docs.cdp.coinbase.com/embedded-wallets)

---

## üéØ Vue d'Ensemble

### Qu'est-ce qu'un Embedded Wallet ?

Un **Embedded Wallet** est un portefeuille crypto **self-custodial** int√©gr√© directement dans ton app, permettant aux users de :
- ‚úÖ Se connecter avec **email/SMS/OAuth** (pas de seed phrases)
- ‚úÖ Cr√©er un wallet en **< 500ms**
- ‚úÖ Garder le **contr√¥le total** de leurs assets
- ‚úÖ **Multi-device** (jusqu'√† 5 appareils)
- ‚úÖ **Aucune extension** navigateur requise

**Diff√©rence avec Server Wallets** :
| Feature | Embedded Wallet | Server Wallet |
|---------|----------------|---------------|
| **Custody** | User | Developer |
| **Auth** | Email OTP, social | API keys |
| **UI** | Frontend React components | Backend API only |
| **Use case** | Users finaux | Backend automation, fees |

---

## üì¶ Installation

### Packages NPM (PUBLICS ‚úÖ)

```bash
# Packages principaux
npm install @coinbase/cdp-react @coinbase/cdp-core @coinbase/cdp-hooks

# Si Next.js
npm install @coinbase/cdp-nextjs

# Si React Native
npm install @coinbase/cdp-react-native
```

**Note importante** : Ces packages sont **publics** et disponibles sur npm !

---

## üèóÔ∏è √âtape 1 : Configuration CDP Portal

### 1.1 Cr√©er un projet

1. Aller sur [portal.cdp.coinbase.com](https://portal.cdp.coinbase.com)
2. Cr√©er un nouveau projet "Embedded Wallets"
3. R√©cup√©rer le **Project ID** (format : `<uuid>`)

### 1.2 Configurer les domaines

**CRITIQUE** : Tu DOIS ajouter tes domaines dans le portail, sinon les wallets ne fonctionneront pas !

**Pour le d√©veloppement** :
- `http://localhost:3001` (ton frontend Next.js)
- `http://localhost:3000` (si port diff√©rent)

**Pour la production** :
- `https://app.cylimit.com` (ou ton domaine)
- **‚ö†Ô∏è NE PAS** ajouter `localhost` en production (risque de s√©curit√©)

**O√π configurer** :
`CDP Portal > Ton projet > Domains Configuration > Add domain`

---

## üîß √âtape 2 : Setup React/Next.js

### 2.1 Wrapper ton app avec CDPReactProvider

**Fichier : `pages/_app.tsx` (Next.js) ou `App.tsx` (React)**

```typescript
import { CDPReactProvider } from "@coinbase/cdp-react";

function App({ Component, pageProps }) {
  return (
    <CDPReactProvider 
      config={{
        projectId: process.env.NEXT_PUBLIC_CDP_PROJECT_ID, // Depuis CDP Portal
        
        // Configuration EVM (Ethereum, Base, Polygon, etc.)
        ethereum: {
          createOnLogin: "smart" // "smart" pour Smart Accounts, "eoa" pour EOA classique
        },
        
        // Configuration Solana (optionnel)
        solana: {
          createOnLogin: true // Cr√©er automatiquement un wallet Solana
        },
        
        appName: "CyLimit", // Nom affich√© dans l'UI auth
      }}
    >
      <Component {...pageProps} />
    </CDPReactProvider>
  );
}

export default App;
```

**Variables d'environnement** :

```bash
# .env.local (Frontend)
NEXT_PUBLIC_CDP_PROJECT_ID=<ton-project-id-depuis-portal>
```

---

## üîê √âtape 3 : Authentification User

### Option A : Utiliser AuthButton (RECOMMAND√â ‚úÖ)

**Le plus simple** : Composant tout-en-un qui g√®re tout le flow auth.

```typescript
import { AuthButton } from "@coinbase/cdp-react/components/AuthButton";
import { useIsSignedIn } from "@coinbase/cdp-hooks";

function WalletAuth() {
  const { isSignedIn } = useIsSignedIn();

  return (
    <div>
      {isSignedIn ? (
        <div>‚úÖ Connect√© !</div>
      ) : (
        <div>
          <h2>Connecte-toi pour continuer</h2>
          <AuthButton />
        </div>
      )}
    </div>
  );
}
```

**Ce que fait `AuthButton` automatiquement** :
1. Affiche un bouton "Sign in with Email"
2. User entre son email
3. User re√ßoit un code OTP par email
4. User entre le code OTP
5. Wallet cr√©√© instantan√©ment (< 500ms)
6. User est authentifi√© ‚úÖ

---

### Option B : Custom Auth UI (Si tu veux contr√¥ler l'UX)

```typescript
import { 
  useSignInWithEmail, 
  useVerifyEmailOTP, 
  useIsSignedIn 
} from "@coinbase/cdp-hooks";
import { useState } from "react";

function CustomAuth() {
  const { signInWithEmail } = useSignInWithEmail();
  const { verifyEmailOTP } = useVerifyEmailOTP();
  const { isSignedIn } = useIsSignedIn();
  
  const [flowId, setFlowId] = useState<string | null>(null);
  const [email, setEmail] = useState('');
  const [otp, setOtp] = useState('');

  // √âtape 1 : Envoyer OTP
  const handleEmailSubmit = async () => {
    try {
      const result = await signInWithEmail({ email });
      setFlowId(result.flowId); // Garder le flowId pour l'√©tape 2
    } catch (error) {
      console.error("Erreur envoi OTP:", error);
    }
  };

  // √âtape 2 : V√©rifier OTP
  const handleOtpSubmit = async () => {
    if (!flowId) return;
    
    try {
      const { user } = await verifyEmailOTP({ flowId, otp });
      console.log("‚úÖ User connect√©, wallet cr√©√©:", user.evmAccounts?.[0]);
    } catch (error) {
      console.error("Erreur v√©rification OTP:", error);
    }
  };

  if (isSignedIn) {
    return <div>‚úÖ Connect√© !</div>;
  }

  return (
    <div>
      {flowId ? (
        // √âtape 2 : Entrer le code OTP
        <div>
          <h2>Entre le code re√ßu par email</h2>
          <input 
            type="text" 
            value={otp} 
            onChange={(e) => setOtp(e.target.value)} 
            placeholder="Code OTP (6 chiffres)" 
          />
          <button onClick={handleOtpSubmit}>V√©rifier</button>
        </div>
      ) : (
        // √âtape 1 : Entrer l'email
        <div>
          <h2>Connecte-toi avec ton email</h2>
          <input 
            type="email" 
            value={email} 
            onChange={(e) => setEmail(e.target.value)} 
            placeholder="ton@email.com" 
          />
          <button onClick={handleEmailSubmit}>Envoyer le code</button>
        </div>
      )}
    </div>
  );
}
```

---

## üí∞ √âtape 4 : Afficher la Balance & Adresse

```typescript
import { useEvmAddress, useBalance } from "@coinbase/cdp-hooks";

function WalletInfo() {
  const { evmAddress } = useEvmAddress(); // Adresse Ethereum/Polygon/Base
  const { balance, isLoading } = useBalance({
    address: evmAddress,
    network: "base-sepolia", // ou "polygon", "ethereum", etc.
    asset: "USDC" // ou "ETH", "MATIC", etc.
  });

  if (!evmAddress) {
    return <div>Wallet pas encore cr√©√©...</div>;
  }

  return (
    <div>
      <h3>Ton Wallet</h3>
      <p>Adresse : {evmAddress}</p>
      <p>Balance : {isLoading ? "..." : `${balance} USDC`}</p>
    </div>
  );
}
```

---

## üöÄ √âtape 5 : Envoyer des Transactions

### 5.1 Avec le composant (SIMPLE ‚úÖ)

```typescript
import { SendEvmTransactionButton } from "@coinbase/cdp-react";
import { useEvmAddress } from "@coinbase/cdp-hooks";

function SendTransaction() {
  const { evmAddress } = useEvmAddress();

  return (
    <SendEvmTransactionButton
      account={evmAddress}
      network="base-sepolia"
      transaction={{
        to: "0xDestinataire...",
        value: 1000000n, // Montant en wei (USDC : 6 decimals)
        chainId: 84532, // Base Sepolia
        type: "eip1559",
      }}
      onSuccess={(hash) => {
        console.log('‚úÖ TX r√©ussie:', hash);
      }}
      onError={(error) => {
        console.error('‚ùå TX √©chou√©e:', error);
      }}
      pendingLabel="Envoi en cours..."
    />
  );
}
```

### 5.2 Avec le hook (PLUS DE CONTR√îLE)

```typescript
import { useSendEvmTransaction } from "@coinbase/cdp-hooks";

function CustomSendTransaction() {
  const { sendTransaction, isPending } = useSendEvmTransaction();

  const handleSend = async () => {
    try {
      const hash = await sendTransaction({
        account: evmAddress,
        network: "base-sepolia",
        transaction: {
          to: "0xDestinataire...",
          value: 1000000n,
          chainId: 84532,
          type: "eip1559",
        }
      });
      
      console.log('‚úÖ TX Hash:', hash);
    } catch (error) {
      console.error('‚ùå Erreur:', error);
    }
  };

  return (
    <button onClick={handleSend} disabled={isPending}>
      {isPending ? "Envoi..." : "Envoyer USDC"}
    </button>
  );
}
```

---

## üíµ √âtape 6 : Int√©grer Coinbase Onramp (Acheter des USDC)

**SUPER IMPORTANT** : Embedded Wallets a un widget Onramp **int√©gr√©** ! Pas de redirection !

### 6.1 Avec le composant (SIMPLE ‚úÖ)

```typescript
import { OnrampButton } from "@coinbase/cdp-react";
import { useEvmAddress } from "@coinbase/cdp-hooks";

function BuyUSDC() {
  const { evmAddress } = useEvmAddress();

  return (
    <OnrampButton
      destinationAddress={evmAddress}
      network="base" // ou "polygon", "ethereum"
      asset="USDC"
      presetAmount={100} // Montant par d√©faut
      onSuccess={(data) => {
        console.log('‚úÖ Achat r√©ussi:', data);
      }}
      onError={(error) => {
        console.error('‚ùå Achat √©chou√©:', error);
      }}
    >
      Acheter des USDC
    </OnrampButton>
  );
}
```

**Ce qui se passe** :
1. User clique sur le bouton
2. Widget Coinbase Onramp s'ouvre **DANS ton app** (pas de redirection !)
3. User entre le montant et paie avec sa CB
4. USDC arrive dans son Embedded Wallet
5. Callback `onSuccess` appel√©

### 6.2 Avec le hook (CUSTOM UI)

```typescript
import { useOnramp } from "@coinbase/cdp-hooks";

function CustomBuyUSDC() {
  const { evmAddress } = useEvmAddress();
  const { openOnramp, isLoading } = useOnramp();

  const handleBuy = async () => {
    try {
      await openOnramp({
        destinationAddress: evmAddress,
        network: "base",
        asset: "USDC",
        presetAmount: 100,
      });
    } catch (error) {
      console.error('‚ùå Erreur Onramp:', error);
    }
  };

  return (
    <button onClick={handleBuy} disabled={isLoading}>
      {isLoading ? "Ouverture..." : "Acheter 100 USDC"}
    </button>
  );
}
```

---

## üîë Hooks Disponibles

### Auth & User

| Hook | Description |
|------|-------------|
| `useIsSignedIn()` | V√©rifie si user est connect√© |
| `useSignInWithEmail()` | Envoie OTP par email |
| `useVerifyEmailOTP()` | V√©rifie le code OTP |
| `useUser()` | Infos du user authentifi√© |
| `useSignOut()` | D√©connecter le user |

### Wallets & Addresses

| Hook | Description |
|------|-------------|
| `useEvmAddress()` | Adresse EVM (Ethereum, Polygon, Base) |
| `useSolanaAddress()` | Adresse Solana |
| `useBalance()` | Balance d'un asset (USDC, ETH, etc.) |

### Transactions

| Hook | Description |
|------|-------------|
| `useSendEvmTransaction()` | Envoyer une TX EVM |
| `useSendSolanaTransaction()` | Envoyer une TX Solana |

### Onramp/Offramp

| Hook | Description |
|------|-------------|
| `useOnramp()` | Ouvrir widget Coinbase Onramp |
| `useOfframp()` | Ouvrir widget Coinbase Offramp |

---

## üé® Composants UI Disponibles

### Auth

- `<AuthButton />` : Bouton complet sign in/sign out
- `<SignInButton />` : Bouton sign in uniquement
- `<SignOutButton />` : Bouton sign out uniquement

### Transactions

- `<SendEvmTransactionButton />` : Bouton pour envoyer TX EVM
- `<SendSolanaTransactionButton />` : Bouton pour envoyer TX Solana

### Onramp/Offramp

- `<OnrampButton />` : Bouton pour acheter crypto (widget int√©gr√©)
- `<OfframpButton />` : Bouton pour vendre crypto vers fiat

### Display

- `<WalletAddress />` : Affiche l'adresse (avec copy)
- `<BalanceDisplay />` : Affiche la balance

---

## üîí Smart Accounts vs EOA

**Tu peux choisir le type de wallet cr√©√©** :

```typescript
<CDPReactProvider 
  config={{
    projectId: "...",
    ethereum: {
      createOnLogin: "smart" // üëà CHOIX ICI
      // Options:
      // - "smart" : Smart Account (ERC-4337) - RECOMMAND√â
      // - "eoa" : Compte classique (Externally Owned Account)
    }
  }}
>
```

**Recommandation** : Utilise **"smart"** (Smart Accounts) car :
- ‚úÖ Gas sponsoring possible
- ‚úÖ Batch transactions (atomique)
- ‚úÖ Plus flexible
- ‚úÖ Meilleure UX

---

## üíª Architecture Hybride pour CyLimit

### Setup Recommand√©

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FRONTEND (Next.js)                 ‚îÇ
‚îÇ  - Embedded Wallets (users)         ‚îÇ
‚îÇ  - Auth email/OTP                   ‚îÇ
‚îÇ  - Widget Onramp int√©gr√©            ‚îÇ
‚îÇ  - Smart Accounts (ERC-4337)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BACKEND (NestJS)                   ‚îÇ
‚îÇ  - Server Wallets (CyLimit)         ‚îÇ
‚îÇ  - Master Wallet (fees)             ‚îÇ
‚îÇ  - Rewards automatiques             ‚îÇ
‚îÇ  - API-driven                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Pourquoi Hybride ?**

1. **Embedded Wallets pour les users** :
   - UX simple (email/OTP)
   - Widget Onramp int√©gr√©
   - Pas de redirection
   - Multi-device

2. **Server Wallets pour CyLimit** :
   - Collecter les fees
   - Payer les rewards
   - Contr√¥le backend total
   - Automation

---

## üåê R√©seaux Support√©s

### EVM (Ethereum Virtual Machine)

- ‚úÖ Ethereum (Mainnet + Sepolia testnet)
- ‚úÖ **Base** (Mainnet + Sepolia testnet) ‚Üê RECOMMAND√â pour CyLimit
- ‚úÖ **Polygon** (Mainnet + Amoy testnet) ‚Üê Actuellement utilis√©
- ‚úÖ Arbitrum
- ‚úÖ Optimism
- ‚úÖ Tous les r√©seaux EVM-compatible

### Non-EVM

- ‚úÖ Solana (Mainnet + Devnet)

**Pour CyLimit** : Utilise **Base** ou **Polygon** pour les faibles gas fees et support USDC natif.

---

## üí∞ Pricing

**Embedded Wallets** :
- ‚úÖ **GRATUIT** pour les 10,000 premi√®res wallets actives/mois
- ‚úÖ **GRATUIT** pour les 50,000 premi√®res transactions/mois
- Apr√®s : $0.02 par wallet actif suppl√©mentaire

**Onramp fees** :
- ‚úÖ Coinbase prend ~3.5% (pay√© par l'user)
- ‚úÖ CyLimit ne paie rien

---

## üé® Theming (Customisation UI)

Tu peux personnaliser les composants UI :

```typescript
<CDPReactProvider 
  config={{
    projectId: "...",
    theme: {
      colors: {
        primary: "#1E40AF", // Bleu CyLimit
        background: "#FFFFFF",
        text: "#000000",
      },
      fonts: {
        body: "Inter, sans-serif",
      },
    }
  }}
>
```

---

## üîê S√©curit√©

### Custody Model

- ‚úÖ **User-custodied** : L'user garde le contr√¥le total
- ‚úÖ **Export priv√© key** : User peut exporter ses cl√©s √† tout moment
- ‚úÖ **Multi-device** : Jusqu'√† 5 appareils synchronis√©s
- ‚úÖ **Encrypted backup** : Backup chiffr√© chez Coinbase

### Coinbase ne peut PAS :

- ‚ùå Acc√©der aux cl√©s priv√©es
- ‚ùå Signer des transactions sans consentement user
- ‚ùå Voler les fonds

### Architecture S√©curit√©

1. Cl√©s priv√©es **fragment√©es** (MPC - Multi-Party Computation)
2. Fragments stock√©s dans **AWS Nitro Enclaves** (hardware-secured)
3. Signature n√©cessite **authentification user** (OTP)
4. Coinbase ne peut **jamais** reconstruire la cl√© compl√®te

---

## ‚ö†Ô∏è Points d'Attention

### 1. Domaines DOIVENT √™tre configur√©s

Sans configuration domaine dans CDP Portal :
- ‚ùå Wallets ne se cr√©eront pas
- ‚ùå Auth √©chouera
- ‚ùå Erreur CORS

**Solution** : Ajouter `http://localhost:3001` ET ton domaine prod dans CDP Portal.

### 2. Variables d'environnement

```bash
# Frontend (.env.local)
NEXT_PUBLIC_CDP_PROJECT_ID=<depuis-portal>

# Backend (.env) - pour Server Wallets
COINBASE_API_KEY_NAME=<depuis-portal>
COINBASE_API_KEY_PRIVATE_KEY=<depuis-portal>
```

### 3. Next.js : "use client" requis

Les composants Embedded Wallets utilisent React hooks (state, effects) :

```typescript
"use client"; // üëà OBLIGATOIRE en haut du fichier

import { AuthButton } from "@coinbase/cdp-react/components/AuthButton";

export default function Page() {
  return <AuthButton />;
}
```

### 4. Network ID vs Chain ID

**Network ID** (pour les hooks CDP) :
- `"base-sepolia"`, `"polygon"`, `"ethereum"`, etc.

**Chain ID** (pour les transactions) :
- Base Sepolia : `84532`
- Polygon Mainnet : `137`
- Ethereum Mainnet : `1`

---

## üìö Liens Documentation

- [Welcome](https://docs.cdp.coinbase.com/embedded-wallets/welcome)
- [Quickstart](https://docs.cdp.coinbase.com/embedded-wallets/quickstart)
- [React Hooks](https://docs.cdp.coinbase.com/embedded-wallets/react-hooks)
- [React Components](https://docs.cdp.coinbase.com/embedded-wallets/react-components)
- [Onramp Integration](https://docs.cdp.coinbase.com/embedded-wallets/onramp-integration)
- [Smart Accounts](https://docs.cdp.coinbase.com/embedded-wallets/smart-accounts)
- [Security & Export](https://docs.cdp.coinbase.com/embedded-wallets/security-export)

---

## ‚úÖ Checklist Impl√©mentation CyLimit

### Setup Initial

- [ ] Cr√©er projet CDP Portal
- [ ] R√©cup√©rer Project ID
- [ ] Configurer domaines (localhost + prod)
- [ ] Installer packages npm

### Frontend

- [ ] Wrapper app avec `<CDPReactProvider>`
- [ ] Configurer Smart Accounts (`createOnLogin: "smart"`)
- [ ] Ajouter auth avec `<AuthButton>` ou custom UI
- [ ] Afficher wallet info (adresse, balance)
- [ ] Int√©grer widget Onramp avec `<OnrampButton>`
- [ ] Tester achat USDC

### Backend (Server Wallets)

- [ ] Garder `CoinbaseWalletService` existant
- [ ] Master Wallet pour collecter fees
- [ ] API pour rewards automatiques

### Tests

- [ ] Auth email/OTP fonctionne
- [ ] Wallet cr√©√© instantan√©ment
- [ ] Balance affich√©e correctement
- [ ] Onramp widget s'ouvre (pas de redirection)
- [ ] Achat USDC fonctionne
- [ ] Transaction USDC fonctionne

---

## üéØ Prochaines √âtapes

1. **Lire la doc Server Wallets** pour comprendre le backend
2. **Lire la doc Onramp/Offramp API** pour les options avanc√©es
3. **Lire la doc API REST** pour les int√©grations backend/frontend

---

**Note cr√©√©e par :** Claude (Assistant IA)  
**Pour :** Valentin @ CyLimit  
**Date :** 7 octobre 2025

**‚úÖ Cette note est compl√®te et pr√™te pour impl√©mentation !**

