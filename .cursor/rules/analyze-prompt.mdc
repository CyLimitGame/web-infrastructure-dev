---
alwaysApply: false
---
# üìã R√®gle : Analyse du Prompt et Chargement du Contexte

## üéØ Objectif
Avant de commencer √† travailler sur une demande, **analyser syst√©matiquement les sujets techniques impliqu√©s** et charger le contexte appropri√©.

## üîç Processus d'Analyse

### 1. Identifier les Sujets Techniques

√Ä chaque nouveau prompt de l'utilisateur, **analyser et identifier** quels sujets techniques sont concern√©s parmi :

#### Sujets Principaux
- **Wallets Coinbase** (Embedded Wallet, CDP, authentification, balance USDC)
- **Marketplace** (achat/vente NFT, listings, fees, approval)
- **Game** (fantasy cyclisme, scoring, teams, races)
- **NFTs** (minting, transfert, metadata, ownership)
- **Backend User** (API REST, auth, database)
- **Backend Admin** (cron jobs, scripts, monitoring)
- **Frontend** (Next.js, React, hooks, components)
- **Infrastructure** (AWS, d√©ploiement, configuration)
- **Tests** (Playwright, E2E, validation)
- **Autres** (tout autre sujet sp√©cifique)

### 2. Charger le Contexte Appropri√©

**AVANT de commencer √† coder ou r√©pondre**, charger les fichiers de contexte pertinents :

#### Mapping Sujet ‚Üí Fichier de Contexte

| Sujet | Fichier de Contexte √† Charger | Tokens | Co√ªt |
|-------|-------------------------------|--------|------|
| **Auth, Login, Signup, OAuth** | `infrastructure/docs/context/CONTEXT_AUTH.md` | ~8,540 | ~$0.025 |
| **Wallets Coinbase** | `infrastructure/docs/context/CONTEXT_MARKETPLACE-WALLET.md` | ~32,000 | ~$0.096 |
| **Marketplace** | `infrastructure/docs/context/CONTEXT_MARKETPLACE-WALLET.md` | ~32,000 | ~$0.096 |
| **Game, Fantasy, Scoring** | `infrastructure/docs/context/CONTEXT_GAME.md` | ~11,700 | ~$0.035 |
| **NFTs** | `infrastructure/docs/context/CONTEXT_MARKETPLACE-WALLET.md` | ~32,000 | ~$0.096 |
| **Backend** | `infrastructure/docs/ETAT_PROJET.md` + fichiers techniques sp√©cifiques | ~8,700 | ~$0.026 |
| **Frontend** | `infrastructure/docs/ETAT_PROJET.md` + fichiers techniques sp√©cifiques | ~8,700 | ~$0.026 |
| **Tests** | `infrastructure/docs/tests/PLAN_TEST_EMBEDDED_WALLET.md` | ~19,800 | ~$0.059 |
| **G√©n√©ral** | `infrastructure/docs/ETAT_PROJET.md` (toujours utile) | ~8,700 | ~$0.026 |

### 3. Communiquer l'Analyse

**Dire explicitement √† l'utilisateur** :
```
"Pour cette t√¢che, j'identifie les sujets suivants :
- [Sujet 1] (ex: Wallets Coinbase)
- [Sujet 2] (ex: Marketplace)

Je vais charger le contexte n√©cessaire avant de commencer :
- CONTEXT_MARKETPLACE-WALLET.md (~32k tokens, ~$0.096)
- ETAT_PROJET.md (~7k tokens, ~$0.021)

Co√ªt total chargement : ~$0.117
"
```

**IMPORTANT :**
- ‚úÖ **TOUJOURS lire les 30 premi√®res lignes** de chaque fichier de contexte AVANT de le charger compl√®tement
- ‚úÖ Chercher la section "üí∞ CO√õT DE CHARGEMENT" dans les premi√®res lignes
- ‚úÖ Extraire le co√ªt et le nombre de tokens
- ‚úÖ Communiquer ces informations √† l'utilisateur AVANT le chargement
- ‚úÖ Si pas de section co√ªt : estimer avec `~12.5 tokens/ligne`

Puis **charger les fichiers** avec `read_file` avant de commencer √† travailler.

## ‚úÖ Exemple d'Application

### Prompt Utilisateur
> "J'ai un bug lors de l'achat d'un NFT sur le marketplace, la balance USDC ne se met pas √† jour"

### Analyse (AVANT de r√©pondre)
```
üîç Analyse du prompt :
Sujets identifi√©s :
- Marketplace (achat NFT)
- Wallets Coinbase (balance USDC)
- Frontend (mise √† jour UI)

Contexte √† charger :
- infrastructure/docs/context/CONTEXT_MARKETPLACE-WALLET.md
- infrastructure/docs/ETAT_PROJET.md

V√©rification des co√ªts...
```

### Actions
1. `read_file` sur `CONTEXT_MARKETPLACE-WALLET.md` (limit√© aux 30 premi√®res lignes)
2. Extraire le co√ªt depuis la section "üí∞ CO√õT DE CHARGEMENT"
3. `read_file` sur `ETAT_PROJET.md` (limit√© aux 30 premi√®res lignes)
4. Extraire le co√ªt (ou estimer si absent)
5. **Communiquer les co√ªts √† l'utilisateur** :
   ```
   Je vais charger le contexte n√©cessaire :
   - CONTEXT_MARKETPLACE-WALLET.md (~32k tokens, ~$0.096)
   - ETAT_PROJET.md (~7k tokens, ~$0.021)
   
   Co√ªt total chargement : ~$0.117
   
   Je charge maintenant les fichiers complets...
   ```
6. `read_file` complet sur `CONTEXT_MARKETPLACE-WALLET.md`
7. `read_file` complet sur `ETAT_PROJET.md`
8. Analyser le code pertinent
9. Proposer une solution inform√©e

## üö´ Ce qu'il NE faut PAS faire

‚ùå **Commencer √† coder imm√©diatement** sans charger le contexte
‚ùå **Deviner** le fonctionnement du syst√®me sans lire la doc
‚ùå **Ignorer** les fichiers de contexte disponibles
‚ùå **Proposer** une solution qui contredit l'architecture document√©e

## ‚úÖ Ce qu'il FAUT faire

‚úÖ **Identifier** les sujets techniques dans le prompt
‚úÖ **Charger** le contexte appropri√© AVANT de r√©pondre
‚úÖ **Communiquer** l'analyse √† l'utilisateur
‚úÖ **Baser** la solution sur le contexte r√©el du projet
‚úÖ **Mettre √† jour** la documentation si changements

## üìù Template de R√©ponse

```markdown
üîç **Analyse du prompt :**

**Sujets identifi√©s :**
- [Sujet 1]
- [Sujet 2]

**Contexte √† charger :**
- [Fichier 1]
- [Fichier 2]

V√©rification des co√ªts de chargement...

[Apr√®s lecture des 30 premi√®res lignes]

üí∞ **Co√ªt du chargement de contexte :**
- [Fichier 1] (~Xk tokens, ~$X.XX)
- [Fichier 2] (~Yk tokens, ~$Y.YY)

**Co√ªt total : ~$Z.ZZ**

Je charge maintenant le contexte complet...

[Apr√®s chargement]

‚úÖ Contexte charg√©. Voici ma compr√©hension du syst√®me actuel :
[R√©sum√© du contexte]

Maintenant je travaille sur votre demande...
```

## üéØ B√©n√©fices

- ‚úÖ **R√©ponses plus pr√©cises** bas√©es sur l'architecture r√©elle
- ‚úÖ **√âvite les erreurs** dues √† une mauvaise compr√©hension
- ‚úÖ **Coh√©rence** avec le code existant
- ‚úÖ **Gain de temps** en chargeant le bon contexte d√®s le d√©part
- ‚úÖ **Transparence** pour l'utilisateur sur la m√©thode de travail
- ‚úÖ **Visibilit√© sur les co√ªts** : l'utilisateur sait combien co√ªte chaque chargement de contexte
- ‚úÖ **Optimisation budget** : permet de d√©cider si le contexte est vraiment n√©cessaire

## üìö Fichiers de Contexte Disponibles

### Contextes Principaux (3 fichiers - 4,213 lignes total)

| Fichier | Sujet | Lignes | Tokens | Co√ªt |
|---------|-------|--------|--------|------|
| **CONTEXT_AUTH.md** | Auth, Login, Signup, OAuth, Email, Password | 683 | ~8,540 | ~$0.025 |
| **CONTEXT_GAME.md** | Fantasy, √âquipes, Scoring, Courses, PCS | 938 | ~11,700 | ~$0.035 |
| **CONTEXT_MARKETPLACE-WALLET.md** | Marketplace, Wallets, NFT, USDC, Contrats | 2,592 | ~32,000 | ~$0.096 |

**Total chargement 3 contextes :** ~52,240 tokens, ~$0.156

### Documents √âtat Projet
- `infrastructure/docs/ETAT_PROJET.md` - √âtat g√©n√©ral (696 lignes, ~8,700 tokens, ~$0.026)
- `infrastructure/docs/PROCHAINES_ETAPES.md` - Roadmap (565 lignes, ~7,060 tokens, ~$0.021)

### Contextes Tests
- `infrastructure/docs/tests/PLAN_TEST_EMBEDDED_WALLET.md` - Tests wallet (1,583 lignes, ~19,800 tokens, ~$0.059)
- `infrastructure/docs/tests/AUTOMATISATION_TESTS_WALLET.md` - Tests E2E (745 lignes, ~9,300 tokens, ~$0.028)

---

**Cette r√®gle s'applique √† CHAQUE nouveau prompt utilisateur.**

---

## üìù APR√àS L'ANALYSE ET LES MODIFICATIONS

### Mise √† Jour des Fichiers de Contexte

**√Ä la fin de chaque t√¢che, √©valuer si les fichiers de contexte doivent √™tre mis √† jour :**

- ‚úÖ **SI** des changements importants ont √©t√© faits sur le syst√®me (architecture, flows, nouveaux composants)
- ‚úÖ **ALORS** mettre √† jour le fichier de contexte appropri√© :
  - Marketplace/Wallets modifi√©s ‚Üí `CONTEXT_MARKETPLACE-WALLET.md`
  - Game modifi√© ‚Üí `CONTEXT_GAME.md`
  - Nouveau sujet majeur ‚Üí Cr√©er nouveau `CONTEXT_[SUJET].md`

**‚ö†Ô∏è IMPORTANT : Mettre √† jour les compteurs de co√ªt**
Apr√®s modification d'un fichier de contexte :
1. Compter les nouvelles lignes : `wc -l [fichier]`
2. Calculer tokens : `lignes √ó 12.5`
3. Calculer co√ªt : `(tokens / 1,000,000) √ó $3`
4. Mettre √† jour la section "üí∞ CO√õT DE CHARGEMENT"
5. Mettre √† jour la date "Derni√®re mise √† jour compteurs"

### ‚ùå CE QU'IL NE FAUT PAS FAIRE

**NE PAS cr√©er de fichiers MD de r√©sum√©/r√©capitulatif automatiquement :**
- ‚ùå Pas de `RECAP_[TACHE].md`
- ‚ùå Pas de `RESUME_[MODIFICATION].md`
- ‚ùå Pas de `CHANGELOG_[DATE].md`
- ‚ùå Pas de documentation automatique des modifications

**√Ä LA PLACE :**
- ‚úÖ **Mettre √† jour `ETAT_PROJET.md`** avec les modifications effectu√©es
- ‚úÖ **Mettre √† jour `PROCHAINES_ETAPES.md`** avec ce qu'il reste √† faire
- ‚úÖ **Demander √† l'utilisateur dans le chat** s'il veut un r√©sum√© d√©taill√© document√© ailleurs
- ‚úÖ Si oui, lui demander **O√ô** mettre ces informations
- ‚úÖ Ne cr√©er un nouveau fichier **QUE si l'utilisateur le demande explicitement**

### Format des Mises √† Jour

#### ETAT_PROJET.md
**Que mettre :**
- ‚úÖ Sujet de la modification (ex: "Optimisation Wallet Context")
- ‚úÖ Fichiers modifi√©s (liste concise)
- ‚úÖ Contexte modifi√© si applicable (ex: "CONTEXT_MARKETPLACE-WALLET.md mis √† jour")
- ‚úÖ Date de la modification

**Que NE PAS mettre :**
- ‚ùå D√©tails techniques ligne par ligne
- ‚ùå Code complet des modifications
- ‚ùå Explications longues (√ßa va dans les fichiers de contexte)

**Exemple :**
```markdown
- ‚úÖ **NOUVEAU (6 Nov 2025 10h30) :** Optimisation appels API - WalletContext
  - Probl√®me : 4-5 fetches balance au refresh page
  - Solution : WalletContext centralis√©
  - Fichiers : src/contexts/WalletContext.tsx, src/hooks/useEmbeddedWallet.ts, src/pages/_app.tsx
  - R√©sultat : -75% appels API
```

#### PROCHAINES_ETAPES.md
**Que mettre :**
- ‚úÖ Marquer comme ‚úÖ les t√¢ches termin√©es
- ‚úÖ Ajouter nouvelles t√¢ches identifi√©es
- ‚úÖ Mettre √† jour les priorit√©s si n√©cessaire
- ‚úÖ Retirer ou archiver les t√¢ches obsol√®tes

**Exemple :**
```markdown
### Optimisations Frontend
- ‚úÖ Optimiser appels API wallet (WalletContext)
- ‚è≥ Optimiser chargement images NFT
- ‚è≥ Impl√©menter lazy loading composants
```

### Template de Question √† l'Utilisateur

```markdown
‚úÖ Modifications termin√©es !

**Changements apport√©s :**
- [Fichier 1]
- [Fichier 2]

**Documentation mise √† jour :**
- ‚úÖ ETAT_PROJET.md (section [X] mise √† jour)
- ‚úÖ PROCHAINES_ETAPES.md (t√¢ches marqu√©es ‚úÖ)
- ‚úÖ [CONTEXT_X.md si applicable]

üìä Souhaitez-vous une documentation plus d√©taill√©e de ces modifications ?
Si oui, indiquez-moi o√π la mettre (nouveau fichier, section sp√©cifique, etc.)
```

### Exemple Pratique

```markdown
‚ùå MAUVAIS (cr√©ation automatique de fichier) :
"J'ai cr√©√© RESUME_OPTIMISATION_WALLET.md pour documenter les changements"

‚úÖ BON (mise √† jour docs + question) :
"‚úÖ Optimisation termin√©e !

Changements apport√©s :
- src/contexts/WalletContext.tsx (cr√©√©)
- src/hooks/useEmbeddedWallet.ts (simplifi√©)
- src/pages/_app.tsx (ajout Provider)

Documentation mise √† jour :
- ‚úÖ ETAT_PROJET.md (section "Embedded Wallet" mise √† jour)
- ‚úÖ PROCHAINES_ETAPES.md (t√¢che "Optimiser appels API" marqu√©e ‚úÖ)

Souhaitez-vous une documentation plus d√©taill√©e de cette optimisation ?
Si oui, indiquez-moi o√π la mettre."
```

### Checklist de Fin de T√¢che

Avant de terminer une t√¢che, v√©rifier :
- [ ] Code modifi√© et test√©
- [ ] `ETAT_PROJET.md` mis √† jour (format concis)
- [ ] `PROCHAINES_ETAPES.md` mis √† jour (t√¢ches ‚úÖ)
- [ ] Fichier de contexte mis √† jour si n√©cessaire
- [ ] Compteurs de co√ªt mis √† jour si contexte modifi√©
- [ ] Question pos√©e √† l'utilisateur pour doc d√©taill√©e
- [ ] **Aucun fichier MD de r√©sum√© cr√©√© automatiquement**

---

**Cette r√®gle s'applique √† CHAQUE nouveau prompt utilisateur.**
